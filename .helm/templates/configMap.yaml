---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Chart.Name }}
data:
  label_master_loop.sh: |
    #!/bin/bash
    if [[ $1 == "--config" ]] ; then
      cat <<EOF
    {
      "configVersion":"v1",
      "kubernetes": [
        {
          "apiVersion": "v1",
          "kind": "Endpoints",
          "executeHookOnEvent": [
            "Added",
            "Modified"
          ],
          "labelSelector": {
            "matchLabels": {
            {{- range $i, $val := .Values.label_endpoint }}
              {{ $i | quote }}: {{ $val | quote }},
            {{- end }}
            }
          },
          "namespace": {
            "nameSelector": {
              "matchNames": [
                {{ .Release.Namespace | quote }}
              ]
            }
          }
        }
      ]
    }
    EOF
    else

      ### for debug
      # set -x
      # cat $BINDING_CONTEXT_PATH >> /tmp/log-$(date +%s).txt

      function atoi
      {
        #Returns the integer representation of an IP arg, passed in ascii dotted-decimal notation (x.x.x.x)
        IP=$1; IPNUM=0
        for (( i=0 ; i<4 ; ++i )); do
          ((IPNUM+=${IP%%.*}*$((256**$((3-${i}))))))
          IP=${IP#*.}
        done
        echo $IPNUM
      }

      ns={{ .Release.Namespace }}
      found=false
      maxIp="0"
      podName=""
      jq_selector=""

      type=$(jq -r '.[0].type' $BINDING_CONTEXT_PATH)

      if [[ $type == "Synchronization" ]] ; then
        jq_selector=".[] | select(.objects != null) | .objects[].object | select(.subsets != null) | .subsets[] | select(.addresses != null) |.addresses[]"
      elif [[ $type == "Event" ]] ; then
        jq_selector=".[].object | select(.subsets != null) | .subsets[] | select(.addresses != null) |.addresses[]"
      fi


      # find all IP from endpoint
      for ip in $(jq -r "$jq_selector | .ip" $BINDING_CONTEXT_PATH)
      do
        a=$(atoi $ip)
        b=$(atoi $maxIp)

        # compare IPs, remember max IP
        if [[ $a > $b ]]; then
          maxIp=$ip
          found=true
        fi
      done

      if $found; then
        # get podName by IP
        podName=$(jq -r "$jq_selector | select(.ip == \"$maxIp\") | .targetRef.name" $BINDING_CONTEXT_PATH)
        if [ -z "${podName}" ]; then
          echo "ERR: could not find any pod by selected ip=$maxIp"; exit 1
        fi
        echo "Elected master is $podName, label it."
        kubectl -n $ns label pod $podName loop-master="true" --overwrite
        for pod in $(kubectl -n $ns get po -l loop-master="true" -o json | jq -r '.items[] | .metadata.name')
        do
          if [ "$pod" != "$podName" ]; then
            echo "Unlabel old master $pod"
            kubectl -n $ns label pod $pod loop-master-
          fi
        done          
      else
        echo "WARN: no one pod was not found" 
      fi        
    fi
